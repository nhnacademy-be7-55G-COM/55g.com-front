<!DOCTYPE html>
<html lang="ko"
      xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/mypage}"
>
<head>
  <title>주소 관리</title>
</head>

<body layout:fragment="mypageContent">
<!-- 배송 주소 -->
<div id="deliveryAddress">
  <h3 style="font-family: 'Pretendard', sans-serif;">배송 주소 관리</h3>
  <div class="info-card">
    <!-- 현재 주소 목록 -->
    <h5 style="font-family: 'Pretendard', sans-serif"><strong>등록된 주소</strong></h5>
    <ul class="list-unstyled">
      <li th:each="address : ${addresses}" class="mb-4">
        <div class="address-card">
          <div>
            <h6 class="address-title">
              <strong th:text="${address.alias()}"></strong>
              <span th:if="${address.isDefault()}" class="badge">기본 배송지</span>
            </h6>
            <p class="address-details"><strong>주소:</strong> <span
                th:text="${address.primaryAddress()}"></span></p>
            <p class="address-details"><strong>상세주소:</strong> <span
                th:text="${address.detailAddress()}"></span></p>
          </div>
          <!-- 버튼 섹션 -->
          <div class="d-flex justify-content-between align-items-center mt-3">
            <!-- 수정 버튼 -->
            <button type="button" class="btn btn-edit btn-sm"
                    data-bs-toggle="modal"
                    th:attr="data-bs-target=${'#editAddressModal' + address.addressId()}">
              수정
            </button>

            <!-- 삭제 버튼 -->
            <form th:action="@{/mypage/deleteAddress}" method="post" class="mb-0">
              <input type="hidden" name="addressId" th:value="${address.addressId()}">
              <button type="submit" class="btn btn-delete btn-sm">삭제</button>
            </form>
          </div>
        </div>
      </li>
    </ul>
    <!-- 주소 추가하기 버튼 -->
    <button class="btn btn-custom btn-lg mt-3" data-bs-toggle="modal"
            data-bs-target="#addAddressModal">
      주소 추가하기
    </button>
  </div>
</div>

<!-- 주소 추가 모달 -->
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel"
     aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content info-card" style="padding: 20px;">
      <div class="modal-header">
        <h5 class="modal-title" id="addAddressModalLabel"
            style="font-family: 'Pretendard', sans-serif; font-weight: bold;">주소 추가</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form th:action="@{/mypage/addAddress}" method="post">

          <!-- 별칭 입력 -->
          <div class="mb-3">
            <label for="addressAlias" class="form-label" style="font-weight: 600;">별칭</label>
            <input type="text" class="form-control form-input" id="addressAlias" name="alias"
                   placeholder="주소의 별칭 (예: 집, 회사)" required>
          </div>

          <!-- 우편번호 입력 및 찾기 버튼 -->
          <div class="mb-3">
            <label for="zipCode" class="form-label" style="font-weight: 600;">우편번호</label>
            <div class="input-group" style="display: flex; align-items: stretch;">
              <!-- 우편번호 입력란 -->
              <input type="text" class="form-control form-input" id="zipCode" name="zipCode"
                     placeholder="우편번호" required readonly
                     style="height: calc(1.5em + .75rem + 2px); margin-top: 15px;margin-right:30px; padding-right: 30px;">
              <!-- 찾기 버튼 -->
              <button type="button" class="btn btn-secondary" onclick="execDaumPostcode()"
                      style="height: calc(1.5em + .75rem + 2px);">
                찾기
              </button>
            </div>
          </div>

          <!-- 주소 입력 -->
          <div class="mb-3">
            <label for="address" class="form-label" style="font-weight: 600;">주소</label>
            <input type="text" class="form-control form-input" id="address" name="primaryAddress"
                   placeholder="주소" required readonly>
          </div>

          <!-- 상세 주소 입력 -->
          <div class="mb-3">
            <label for="detailAddress" class="form-label" style="font-weight: 600;">상세 주소</label>
            <input type="text" class="form-control form-input" id="detailAddress"
                   name="detailAddress" placeholder="상세 주소 입력" required>
          </div>

          <!-- 기본 배송지 여부 -->
          <div class="form-check mb-3" style="padding-left: 1.5em;">
            <input type="checkbox" class="form-check-input" id="setAsDefault" name="isDefault"
                   value="true">
            <label class="form-check-label" for="setAsDefault" style="font-weight: 600;">기본 주소지로
              설정</label>
          </div>

          <!-- 제출 버튼 -->
          <div class="d-grid mt-4">
            <button type="submit" class="btn btn-custom" onclick="prepareFormAndSubmit()">주소 추가
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<<!-- 기본 배송지 수정 모달 -->
<div th:each="address : ${addresses}"
     th:id="'editAddressModal' + ${address.addressId()}"
     class="modal fade" tabindex="-1" aria-labelledby="editAddressModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content info-card">
      <div class="modal-header">
        <h5 class="modal-title" id="editAddressModalLabel">수정</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form th:action="@{/mypage/updateAddress}" method="post" id="editAddressForm">
          <input type="hidden" name="addressId" th:value="${address.addressId()}">

          <!-- 별칭 입력 -->
          <div class="mb-3">
            <label for="alias" class="form-label">별칭</label>
            <input type="text" class="form-control form-input" id="alias" name="alias"
                   th:value="${address.alias()}" placeholder="예: 집, 회사">
          </div>

          <!-- 기본 배송지 여부 -->
          <div class="form-check mb-3 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <input type="checkbox" class="form-check-input" id="isDefault" name="isDefault"
                     value="true"
                     th:checked="${address.isDefault()}">
              <label class="form-check-label ms-2" for="isDefault">기본 배송지로 설정</label>
            </div>

          </div>

          <button type="button" class="btn btn-custom btn-sm" onclick="submitIsDefault()">설정
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
<script>
  function prepareFormAndSubmit() {
    const checkbox = document.getElementById("setAsDefault");

    // 체크박스가 체크되지 않았으면 value를 "false"로 설정
    if (!checkbox.checked) {
      // hidden input 생성
      const hiddenFalseInput = document.createElement("input");
      hiddenFalseInput.type = "hidden";
      hiddenFalseInput.name = checkbox.name;
      hiddenFalseInput.value = "false";
      checkbox.form.appendChild(hiddenFalseInput);
    }

    // 폼 제출
    checkbox.form.submit();
  }

  function submitIsDefault() {
    const checkbox = document.getElementById("isDefault");

    if (!checkbox.checked) {
      const hiddenFalseInput = document.createElement("input");
      hiddenFalseInput.type = "hidden";
      hiddenFalseInput.name = checkbox.name;
      hiddenFalseInput.value = "false";
      checkbox.form.appendChild(hiddenFalseInput);
    }

    // 폼 제출
    checkbox.form.submit();
  }
</script>

<!-- 카카오 주소 API -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
  function execDaumPostcode() {
    new daum.Postcode({
      oncomplete: function (data) {
        document.getElementById("zipCode").value = data.zonecode;
        document.getElementById("address").value = data.address;
        document.getElementById("detailAddress").focus();
      }
    }).open();
  }
</script>
</body>
</html>