<!DOCTYPE html>
<html lang="ko"
      xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/mypage}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>좋아요</title>
</head>
<body layout:fragment="mypageContent">
<h1>좋아요 목록</h1>

<div class="tab-pane fade show active" id="likes" role="tabpanel">
    <table id="likes-table">
        <thead>
        <tr>
            <th>도서 제목</th>
            <th>가격</th>
            <th>출판사</th>
            <th>상태</th>
            <th>삭제</th> <!-- 삭제 버튼 열 추가 -->
        </tr>
        </thead>
        <tbody>
        <!-- 좋아요 목록이 여기에 추가됩니다. -->
        </tbody>
    </table>
</div>

<script>
    // 페이지 로드 시 좋아요 목록 자동 로드
    function loadLikes() {
        fetch('/mypage/like/list', {method: 'GET'})
            .then(response => {
                if (!response.ok) {
                    throw new Error('네트워크 응답이 올바르지 않습니다.');
                }
                return response.json();
            })
            .then(books => {
                const likesTableBody = document.querySelector('#likes-table tbody');
                likesTableBody.innerHTML = ''; // 기존 내용을 지우기

                books.forEach(book => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                            <td>${book.title}</td>
                            <td>${book.price}</td>
                            <td>${book.publisher}</td>
                            <td>${book.status}</td>
                            <td>
                                <button data-book-id="${book.bookId}" class="btn-delete">삭제</button>
                            </td>
                        `;
                    likesTableBody.appendChild(row);
                });

                // 삭제 버튼 이벤트 설정
                document.querySelectorAll('.btn-delete').forEach(button => {
                    button.addEventListener('click', function () {
                        const bookId = this.getAttribute('data-book-id');
                        fetch(`/mypage/like/delete/${bookId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json', [_csrf_header]: _csrf
                            }
                        })
                            .then(response => {
                                if (response.ok) {
                                    alert('삭제되었습니다.');
                                    loadLikes(); // 목록 갱신
                                } else {
                                    alert('삭제에 실패했습니다.');
                                }
                            })
                            .catch(error => console.error('Error:', error));
                    });
                });

            })
            .catch(error => {
                console.error('오류 발생:', error);
                alert('좋아요 목록을 불러오는 데 실패했습니다.');
            });
    }

    // 페이지 로드 시 자동으로 호출
    document.addEventListener('DOMContentLoaded', loadLikes);
</script>
</body>
</html>
