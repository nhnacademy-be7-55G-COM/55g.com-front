<!DOCTYPE html>
<html lang="ko"
      xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/mypage}"
>
<head>
  <meta charset="UTF-8">
  <title>나의 주문 내역</title>
  <script src="/static/js/mypage-utils.js"></script>
  <script>
    const callOrderHistoryPage = async (tableSelector, {startDate, endDate}) => {
      const table = document.querySelector(tableSelector);
      const orders = (await axios.get('/mypage/support/orders',
          {params: {startDate: startDate, endDate: endDate}}
      )).data;

      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';
      orders.forEach(order => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-order-id', order.orderId);

        const orderId = document.createElement('td');
        orderId.innerHTML = order.orderId;

        const totalPrice = document.createElement('td');
        totalPrice.innerHTML = order.totalPrice;

        const representTitle = document.createElement('td');
        representTitle.innerHTML = order.representTitle;

        const orderedAt = document.createElement('td');
        orderedAt.innerHTML = order.orderedAt;

        const quantity = order.totalQuantity;
        const kind = order.totalKind;

        if (kind > 1) {
          representTitle.innerHTML = `<p>${representTitle.innerHTML} 등</p><p>${kind} 종류 ${quantity} 권</p>`;
        } else if (quantity > 1) {
          representTitle.innerHTML = `${representTitle.innerHTML} ${quantity}권`;
        }

        tr.append(orderId, representTitle, totalPrice, orderedAt);
        tr.style.cursor='pointer';
        tr.addEventListener('click', () => window.location.href=`/mypage/order/${order.orderId}`);
        // applyOrderDetailTemplate(tr);
        tbody.appendChild(tr);
      });
    }
  </script>
</head>
<body>

<div class="container" layout:fragment="mypageContent">
  <div class="mb-3" style="font-size: 2rem; font-weight: bold;">내 주문 내역</div>
  <div id="orderHistory">
    <div class="d-flex">
      <input type="date" class="order-date-input" id="startDateInput" name="startDate" />
      <span>부터</span>
      <input type="date" class="order-date-input" id="endDateInput" name="endDate" />
      <span>까지</span>
      <button onclick="fetchOrders()" type="button" id="orderSearchButton">검색</button>
    </div>
    <table class="table table-hover" id="orderHistoryTable">
      <thead>
      <tr>
        <th scope="col">ID</th>
        <th scope="col" style="width: 65%">주문 내용</th>
        <th scope="col">주문 가격</th>
        <th scope="col">주문 일시</th>
      </tr>
      </thead>
      <tbody>

      </tbody>
    </table>
    <script>
      const startDateInput = document.querySelector('#startDateInput');
      const endDateInput = document.querySelector('#endDateInput');
      const tableSelector = '#orderHistoryTable';
      const table = document.querySelector(tableSelector);

      const fetchOrders = async () => {
        if (startDateInput.value == null || endDateInput.value == null) {
          alert('날짜를 입력해주세요.');
        }
        const start = startDateInput.valueAsDate;
        const end = endDateInput.valueAsDate;
        if (start > end) {
          alert(`시작날짜는 ${end}보다 앞선 시점이어야 합니다.`);
        }

        await callOrderHistoryPage(tableSelector, {
          startDate: startDateInput.value,
          endDate: endDateInput.value
        });
      }
    </script>
  </div>
</div>

</body>
</html>