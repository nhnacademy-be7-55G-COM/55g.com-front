<!DOCTYPE html>
<html lang="ko"
      xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/mypage}"
>
<head>
  <meta charset="UTF-8">
  <title>나의 주문 내역</title>
  <script src="/static/js/mypage-utils.js"></script>
</head>
<body>

<div class="container" layout:fragment="mypageContent">
  <div class="mb-3" style="font-size: 2rem; font-weight: bold;">내 주문 내역</div>
  <div id="orderHistory">
    <form class="d-flex">
      <input type="date" class="order-date-input" id="startDateInput" name="startDate" th:value="${startDate}" />
      <span>부터</span>
      <input type="date" class="order-date-input" id="endDateInput" name="endDate" th:value="${endDate}" />
      <span>까지</span>
      <button onclick="fetchOrders()" type="button" id="orderSearchButton">검색</button>
    </form>
    <table class="table table-hover" id="orderHistoryTable">
      <thead>
      <tr>
        <th scope="col" style="width: 65%">주문 내용</th>
        <th scope="col">주문 가격</th>
        <th scope="col">주문 일시</th>
      </tr>
      </thead>
      <tbody>
      <th:block th:each="order: ${orders}">
        <tr th:data-order-uuid="${order.uuid}">
          <td th:if="${order.totalKind > 1}">
            <p th:text="|${order.representTitle} 등|"></p>
            <p th:text="|${order.totalKind} 종류 ${order.totalQuantity} 권|"></p>
          </td>
          <td th:unless="${order.totalKind > 1}">
            <p th:text="|${order.representTitle} ${order.totalQuantity}|"></p>
          </td>
          <td th:text="${order.totalPrice}"></td>
          <td th:text="${#temporals.format(order.orderedAt, 'yyyy-MM-dd HH:mm')}"></td>
        </tr>
      </th:block>
      </tbody>
    </table>
    <script>
      const startDateInput = document.querySelector('#startDateInput');
      const endDateInput = document.querySelector('#endDateInput');
      const tableSelector = '#orderHistoryTable';
      const table = document.querySelector(tableSelector);

      const fetchOrders = async () => {
        if (startDateInput.value == null || endDateInput.value == null || startDateInput === '' || endDateInput === '') {
          alert('날짜를 입력해주세요.');
        }
        const start = startDateInput.valueAsDate;
        const end = endDateInput.valueAsDate;
        if (start > end) {
          alert(`시작날짜는 ${end}보다 앞선 시점이어야 합니다.`);
        }

        await callOrderHistoryPage(tableSelector, {
          startDate: startDateInput.value,
          endDate: endDateInput.value
        });
      }
    </script>
    <script>
      const rows = document.querySelectorAll('#orderHistoryTable tr');
      rows.forEach(row => {
        row.style.cursor = 'pointer';
        row.addEventListener('click', () => {
          window.location.href='/mypage/order/'+row.getAttribute('data-order-uuid');
        });
      });
    </script>
  </div>
</div>

</body>
</html>