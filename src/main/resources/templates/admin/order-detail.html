<!DOCTYPE html>
<html lang="ko"
      xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}"
      layout:fragment="content"
>
<head>
  <meta charset="UTF-8">
  <title>주문 상세</title>
  <style>
  </style>
</head>
<body>
<div class="container p-3">
  <div class="display-4">주문 상세</div>
  <div>
    <table class="table">
      <thead>
      <tr>
        <th scope="col">주문상세 ID</th>
        <th scope="col">제목</th>
        <th scope="col">권 수</th>
        <th scope="col">총 가격</th>
        <th scope="col">적립가격</th>
        <th scope="col">포장지</th>
      </tr>
      </thead>
      <tbody>
      <th:block th:each="detail: ${info.details}">
      <tr>
        <td th:text="${detail.orderDetailId}"></td>
        <td><a th:href="@{/book/{bookId}(bookId=${detail.bookId})}" th:text="${detail.bookTitle}"></a></td>
        <td th:text="${detail.quantity}"></td>
        <td th:text="${detail.totalPrice}"></td>
        <td th:text="${detail.accumulationPrice}"></td>
        <th:block th:if="${detail.wrappingPaperName == null || detail.wrappingPaperName.isEmpty()}"><td>없음</td></th:block>
        <th:block th:unless="${detail.wrappingPaperName == null || detail.wrappingPaperName.isEmpty()}">
          <td th:text="${detail.wrappingPaperName}"></td>
        </th:block>
      </tr>
      </th:block>
      </tbody>
    </table>
  </div>

  <hr/>

  <div class="display-5">배송상태</div>
  <form id="editForm" th:action="@{/admin/order/delivery/{id}(id=${info.delivery.id})}" method="post">
    <input type="number" name="id" th:value="${info.delivery.id}" hidden disabled/>
    <div class="container">
      <div class="row mb-3">
        <div class="col-md-8">
          <label class="form-label" for="addressInput">배송주소</label>
          <input type="text" id="addressInput" name="address" th:value="${info.delivery.address}" required disabled class="form-control" />
        </div>
        <div class="col-md-4">
          <label class="form-label" for="invoiceInput">송장</label>
          <input type="text" id="invoiceInput" name="invoiceNumber" th:value="${info.delivery.invoiceNumber}" disabled class="form-control" />
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label" for="receiverName">받는 사람</label>
          <input type="text" id="receiverName" name="receiverName" th:value="${info.delivery.receiverName}" disabled class="form-control" required />
        </div>
        <div class="col-md-4">
          <label class="form-label" for="receivedDate">받길 희망하는 날짜</label>
          <input type="date" id="receivedDate" name="receivedDate" th:value="${#temporals.format(info.delivery.receivedDate, 'yyyy-MM-dd')}" disabled class="form-control" required />
        </div>
        <div class="col-md-4">
          <label class="form-label" for="shippingDate">출고일</label>
          <input type="date" id="shippingDate" name="shippingDate" th:value="${#temporals.format(info.delivery.shippingDate, 'yyyy-MM-dd')}" disabled class="form-control" />
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4">
          <label for="deliveryStatus">배송상태</label>
          <select name="status" id="deliveryStatus" disabled class="form-select" onchange="selectorChangeHandler(this)">
            <option value="PREPARING">배송준비중</option>
            <option value="SHIPPING">배송중</option>
            <option value="DELIVERED">배송완료</option>
          </select>
        </div>
      </div>

      <script th:inline="javascript">
        const shippingStatus = [[${info.delivery.status}]];
        const selectForm = document.querySelector('#deliveryStatus');
        const options = selectForm.querySelectorAll('option');
        options.forEach(option => {
          if (option.value === shippingStatus) {
            option.selected = true;
          }
        });
      </script>
    </div>
    <div class="d-flex flex-column">
      <button type="button" class="btn btn-outline-warning ms-auto" onclick="enableModify()">배송 정보 수정하기</button>
      <button type="submit" id="applyBtn" class="btn btn-primary ms-3" disabled>적용하기</button>
      <script>
        const selectorChangeHandler = (selector) => {
          if (selector.value === 'SHIPPING' || selector.value === 'DELIVERED') {
            document.querySelector('#invoiceInput').required = true;
            document.querySelector('#shippingDate').required = true;
          } else {
            document.querySelector('#invoiceInput').required = false;
            document.querySelector('#shippingDate').required = false;
          }
        }
      </script>
    </div>
  </form>

  <hr/>
  <div class="display-4">환불정보</div>
  <div>
    <table class="table">
      <thead>
      <tr>
        <th scope="col">제목</th>
        <th scope="col">권 수</th>
        <th scope="col">환불타입</th>
        <th scope="col">환불사유</th>
        <th scope="col">환불시각</th>
      </tr>
      </thead>
      <tbody>
      <th:block th:each="refund: ${info.refunds}">
      <th:block th:if="${refund != null}">
      <tr>
        <td th:text="${refund.bookTitle}"></td>
        <td th:text="${refund.quantity}"></td>
        <td th:text="${refund.type}"></td>
        <td th:text="${refund.reason}"></td>
        <td th:text="${#temporals.format(refund.refundedAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
      </tr>
      </th:block>
      </th:block>
      </tbody>
    </table>
  </div>
</div>
</body>
<script>
  const enableModify = () => {
    const applyButton = document.querySelector('#applyBtn');
    applyButton.disabled = false;
    const inputs = document.querySelectorAll('form input,select');
    inputs.forEach((input) => {
      input.disabled = false;
    });
  };
</script>
</html>