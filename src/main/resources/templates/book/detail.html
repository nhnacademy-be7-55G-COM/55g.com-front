<!DOCTYPE html>
<html
    xmlns:layout="http://ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/default}">
<head>
  <style>

    .btn-coupon {
      text-align: left;
      width: 60%;
      height: 100%;
    }

    .btn-coupon > span {
      white-space: normal;
    }

    .btn-purchase {
      margin: 15px 10px 15px 0px;
    }

    .quantity-selector {
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ccc; /* 외부 테두리 */
      border-radius: 5px; /* 둥근 모서리 */
      overflow: hidden; /* 내부 경계 제거 */
      width: 140px; /* 전체 폭 */
      height: 40px; /* 버튼과 입력 필드 높이 */
    }

    /* 버튼 스타일 */
    .quantity-selector .btn {
      background-color: #d7b89c; /* 버튼 배경색 */
      border: none; /* 개별 테두리 제거 */
      color: white; /* 버튼 텍스트 색상 */
      font-size: 16px; /* 텍스트 크기 */
      font-weight: bold; /* 텍스트 굵기 */
      cursor: pointer;
      width: 40px; /* 버튼 폭 */
      height: 100%; /* 버튼 높이 부모 높이와 일치 */
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
    }

    .quantity-selector .btn:hover {
      background-color: #c19b82; /* 버튼 hover 배경색 */
    }

    /* 입력 필드 스타일 */
    .quantity-input {
      border: none; /* 기본 테두리 제거 */
      text-align: center; /* 텍스트 가운데 정렬 */
      font-size: 16px; /* 텍스트 크기 */
      width: 60px; /* 입력 필드 폭 */
      height: 100%; /* 높이 부모 높이와 일치 */
      -moz-appearance: textfield; /* Firefox 스피너 제거 */
      appearance: textfield; /* 크로스 브라우저 스피너 제거 */
      padding: 0; /* 여백 제거 */
      margin: 0; /* 외부 여백 제거 */
      box-sizing: border-box; /* 박스 크기 계산 방식 조정 */
    }

    .quantity-input::-webkit-inner-spin-button,
    .quantity-input::-webkit-outer-spin-button {
      -webkit-appearance: none; /* Chrome, Safari에서 스피너 제거 */
      margin: 0; /* 스피너 공간 제거 */
    }

    .quantity-input:focus {
      outline: none; /* 포커스 시 기본 테두리 제거 */
    }
  </style>
</head>
<!--<div th:replace="~{fragments/head}"></div>-->
<body layout:fragment="content">
<!--<div th:replace="~{fragments/header}"></div>-->
<!-- 본문 시작 -->
<main>
  <div class="container mt-5">
    <div class="row">
      <div class="col-lg-4">
        <img th:src="'https://image.toast.com/aaaacko/55gshop/book/thumbnails/'+${book.imagePath}"
             class="img-fluid" alt="Product Image">
      </div>
      <div class="col-lg-8">
        <h1 class="product-title" th:text="${book.title}"></h1>
        <p class="product-details"><span th:each="author,stat:${book.authorList}"><span
            th:text="${author.authorName}"></span>(<span th:text="${author.typeName}"></span>)<span
            th:if="${!stat.last}">,</span></span>
          | <span th:text="${book.publisherName}"></span></p>
        <div>
          <span class="ratings" th:each="category,stat:${book.categoryList}">
            <a th:href="@{/book/list/category(name=${category.categoryName})}"><span th:text="${category.categoryName}"></span></a>
            <span th:if="${!stat.last}">></span>
          </span>
        </div>
        <div class="product-price mt-3">
          정가: <span class="original-price"
                    th:text="${#numbers.formatDecimal(book.price, 0, 'COMMA', 0, 'COMMA')}"></span>원
          <!-- TODO: 실제 판매가 계산 후 반영하기 -->
          <!--          <h3 class="sale-price text-danger">판매가: 8,100원</h3>-->
        </div>
        <div th:if="${book.countCoupons>0}" style="width:100%;">
          <button class="btn btn-success btn-coupon"><strong>받을 수 있는 쿠폰이 존재합니다!</strong><br/>
            쿠폰 받기<br/>
          </button>
<!--          <h3 class="sale-price text-danger">판매가: 8,100원</h3>-->
        </div>
        <div class="quantity-selector">
          <button type="button" class="btn-decrement" onclick="decrement()">−</button>
          <input type="number" class="quantity-input" id="quantity" value="1" min="1" />
          <button type="button" class="btn-increment" onclick="increment()">+</button>
        </div>
        <div class="btn-group mt-3">
          <button class="btn btn-primary btn-purchase" onclick="putTOCart()">카트에 넣기</button>
          <button class="btn btn-success btn-purchase">바로 구매</button>
        </div>
      </div>
      <hr>

      <div>
        <ul>
          <li>발행일 : <span th:text="${book.publishedDate}"></span></li>
          <li>설명 : <span th:text="${book.description}"></span></li>
        </ul>
      </div>
    </div>
  </div>
</main>
<!-- 본문 끝 -->
<div th:replace="~{fragments/footer}"></div>

<script>

  const bookQuantity = document.getElementById('quantity');
  const stock = [[${book.stock}]];

  bookQuantity.addEventListener('input', () => {
    const min = 1;

    // 한글, 특수문자 제거
    bookQuantity.value = bookQuantity.value.replace(/[^0-9]/g, '');

    // 최소값 유지
    if (bookQuantity.value === '' || parseInt(bookQuantity.value, 10) < min) {
      bookQuantity.value = min;
    }

    const currentValue = parseInt(bookQuantity.value, 10);
    if (currentValue > stock) {
      bookQuantity.value = stock;
      alert(`현재재고는 ${stock}개 입니다.`);
    }
  });

  bookQuantity.addEventListener('keydown', (event) => {
    const currentValue = parseInt(bookQuantity.value, 10);
    const min = 1;

    // 백스페이스, Delete 키 사용을 차단 (최소값일 경우만)
    if ((event.key === 'Backspace' || event.key === 'Delete') && currentValue <= min) {
      event.preventDefault();
    }

    // 숫자가 아닌 다른 키 입력 방지 (한글은 조합문자라서 처리가 안되는듯하다)
    if (
        !/^[0-9]$/.test(event.key) && // 숫자 키 외의 입력 방지
        event.key !== 'Backspace' &&
        event.key !== 'Delete' &&
        event.key !== 'ArrowLeft' &&
        event.key !== 'ArrowRight'
    ) {
      event.preventDefault();
    }
  });



  function decrement(){
    let currentQuantity = parseInt(bookQuantity.value,10);
    if (currentQuantity > 1){
      bookQuantity.value = currentQuantity - 1;
    }
  }

  function increment() {
    let currentQuantity = parseInt(bookQuantity.value,10);
    if (currentQuantity < stock){
      bookQuantity.value = currentQuantity + 1;
    }
  }


  async function putTOCart(){
    console.log('putting start');
    const isloggedIn = await isLoggedIn();

    if (isloggedIn){
      fetch("/cart",{
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          bookId: [[${book.bookId}]],
          quantity: parseInt(bookQuantity.value,10)
        })
      })
      .then(response =>{
        if (response.ok){

          return response.json();

        } else {
          alert("장바구니 담는데 실패했습니다.");
        }
      })
      .then(data =>{

        const cartCountChange = parseInt(data.cartCountChange,10);
        if (cartCountChange == 1){
          updateCartCountWhenPutting()
        }
        alert("장바구니 담기에 성공했습니다.");

      })
      .catch(error => {
        console.error('Error putting item:', error);
      })
    } else {
      try {
        console.log('비회원 장바구니 담기')

        if (!localStorage.getItem('cart')) {
          localStorage.setItem('cart', JSON.stringify({cartBookInfoList: []}));
          localStorage.setItem('cartCount', 0);
        }

        let cartData = JSON.parse(localStorage.getItem('cart'));
        let book = cartData.cartBookInfoList.find(book => book.bookId === [[${book.bookId}]]);

        if (book){
          book.quantity += parseInt(bookQuantity.value,10);
        }else {
          cartData.cartBookInfoList.push({bookId:[[${book.bookId}]],quantity:parseInt(bookQuantity.value,10),status:true});
          updateCartCountWhenPutting();

        }

        localStorage.setItem('cart', JSON.stringify(cartData));
        alert('장바구니에 담겼습니다.');

      } catch (error) {
        alert("장바구니에 담는데 실패했습니다. 다시 시도해주세요");
      }

    }
  }

  function updateCartCountWhenPutting() {
    const cartCountElement = document.getElementById('cart-count');

    let newCount = parseInt(localStorage.getItem('cartCount')) + 1;

    cartCountElement.innerText = newCount;
    localStorage.setItem('cartCount', newCount);

  }
</script>
</body>
</html>
